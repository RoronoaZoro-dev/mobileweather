import 'dart:convert';
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import 'package:shared_preferences/shared_preferences.dart';

class WeatherProvider extends ChangeNotifier {
  final String? apiKey;
  WeatherProvider({required this.apiKey}) {
    loadPastData();
  }

  Map<String, dynamic>? weatherData;
  List<Map<String, dynamic>> pastData = [];
  String? lastCity;

  bool get hasApiKey => (apiKey != null && apiKey!.isNotEmpty);

  Future<void> fetchWeatherByCoords(double lat, double lon) async {
    if (!hasApiKey) throw Exception('API key missing');
    final url =
        'https://api.openweathermap.org/data/2.5/onecall?lat=$lat&lon=$lon&exclude=minutely,hourly,alerts&appid=$apiKey&units=metric';
    final response = await http.get(Uri.parse(url));
    if (response.statusCode == 200) {
      weatherData = json.decode(response.body);
      await _storePastData(weatherData!);
      notifyListeners();
    } else {
      throw Exception('Failed to load weather: ${response.statusCode}');
    }
  }

  Future<void> fetchWeatherByCity(String city) async {
    if (!hasApiKey) throw Exception('API key missing');
    final geoUrl =
        'https://api.openweathermap.org/geo/1.0/direct?q=${Uri.encodeComponent(city)}&limit=1&appid=$apiKey';
    final geoResp = await http.get(Uri.parse(geoUrl));
    if (geoResp.statusCode == 200) {
      final list = json.decode(geoResp.body) as List;
      if (list.isEmpty) throw Exception('City not found');
      final first = list.first;
      final lat = (first['lat'] as num).toDouble();
      final lon = (first['lon'] as num).toDouble();
      lastCity = first['name'];
      await fetchWeatherByCoords(lat, lon);
    } else {
      throw Exception('Failed to find city: ${geoResp.statusCode}');
    }
  }

  Future<List<String>> fetchCitySuggestions(String query) async {
    if (query.trim().isEmpty || !hasApiKey) return [];
    final url =
        'https://api.openweathermap.org/geo/1.0/direct?q=${Uri.encodeComponent(query)}&limit=5&appid=$apiKey';
    final resp = await http.get(Uri.parse(url));
    if (resp.statusCode == 200) {
      final list = json.decode(resp.body) as List;
      return list
          .map((e) =>
              '${e['name'] ?? ''}${e['state'] != null ? ', ${e['state']}' : ''}, ${e['country'] ?? ''}')
          .toList();
    }
    return [];
  }

  Future<void> _storePastData(Map<String, dynamic> data) async {
    final prefs = await SharedPreferences.getInstance();
    final minimal = {
      'dt': data['current']?['dt'],
      'current': data['current'],
    };
    pastData.insert(0, Map<String, dynamic>.from(minimal));
    if (pastData.length > 365) pastData = pastData.sublist(0, 365);
    prefs.setString('pastData', json.encode(pastData));
  }

  Future<void> loadPastData() async {
    final prefs = await SharedPreferences.getInstance();
    final data = prefs.getString('pastData');
    if (data != null) {
      try {
        final decoded = json.decode(data) as List;
        pastData = decoded.map((e) => Map<String, dynamic>.from(e)).toList();
      } catch (_) {
        pastData = [];
      }
    }
    notifyListeners();
  }
}
